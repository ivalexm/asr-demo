<head>
    <title>ThoughtWorks ASR Demo</title>
    <script src="http://upcdn.b0.upaiyun.com/libs/jquery/jquery-2.0.3.min.js" type="application/javascript"></script>
    <script src="scripts/recorder.js" type="application/javascript"></script>
</head>

<body>
<form enctype="multipart/form-data">
    <label for="wav">Select File</label>
    <input id="wav" type="file" name="wav">
    <input id="wav-submit" type="button" name="submit" value="Submit">
</form>
<div id="task-result">
</div>

<button onclick="startRecording(this);">record</button>
<button onclick="stopRecording(this);" disabled>stop</button>

<h2>Log</h2>
<pre id="log"></pre>

<script>
    function uploadWAV(formData) {
        $.ajax({
                    url: '/tasks',  //Server script to process data
                    type: 'POST',
                    data: formData,
                    cache: false,
                    processData: false,
                    contentType: false
                })
                .done(function (data) {
                    function getStatus(id) {
                        $.get('/tasks/' + id)
                                .done(function (data) {
                                    var result = $.parseJSON(data);
                                    if (result.status == 'pending') {
                                        $('#task-result').text("processing");
                                        setTimeout(function () {
                                            getStatus(id)
                                        }, 5000);
                                    } else {
                                        $('#task-result').text(result.result);
                                    }
                                })
                    }

                    getStatus(data.id);
                })
                .error(function (error) {
                    $('#task-result').text(error);
                });
    }

    $('#wav-submit').click(function () {
        var formData = new FormData($('form')[0]);
        uploadWAV(formData);
    });

    function __log(e, data) {
        log.innerHTML += "\n" + e + " " + (data || '');
    }
    var audio_context;
    var recorder;
    var resampler;

    function startUserMedia(stream) {
        var input = audio_context.createMediaStreamSource(stream);
        __log('Media stream created.');

        recorder = new Recorder(input);
        __log('Recorder initialised.');
    }

    function startRecording(button) {
        recorder && recorder.record();
        button.disabled = true;
        button.nextElementSibling.disabled = false;
        __log('Recording...');
    }

    function stopRecording(button) {
        recorder && recorder.stop();
        button.disabled = true;
        button.previousElementSibling.disabled = false;
        __log('Stopped recording.');

        recorder && recorder.exportWAV(function (blob) {
            var formData = new FormData();
            formData.append('wav', blob);
            uploadWAV(formData);
        });

        recorder.clear();
    }

    window.onload = function init() {
        try {
            // webkit shim
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
            window.URL = window.URL || window.webkitURL;

            audio_context = new AudioContext;
            __log('Audio context set up.');
            __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
        } catch (e) {
            alert('No web audio support in this browser!');
        }

        navigator.getUserMedia({audio: true}, startUserMedia, function (e) {
            __log('No live audio input: ' + e);
        });
    };
</script>
</body>

